<!-- Sigma and Linkurious import -->
<script src="/static/linkurious/src/sigma.core.js"></script>
<script src="/static/linkurious/src/conrad.js"></script>
<script src="/static/linkurious/src/utils/sigma.utils.js"></script>
<script src="/static/linkurious/src/utils/sigma.polyfills.js"></script>
<script src="/static/linkurious/src/sigma.settings.js"></script>
<script src="/static/linkurious/src/classes/sigma.classes.dispatcher.js"></script>
<script src="/static/linkurious/src/classes/sigma.classes.configurable.js"></script>
<script src="/static/linkurious/src/classes/sigma.classes.graph.js"></script>
<script src="/static/linkurious/src/classes/sigma.classes.camera.js"></script>
<script src="/static/linkurious/src/classes/sigma.classes.quad.js"></script>
<script src="/static/linkurious/src/classes/sigma.classes.edgequad.js"></script>
<script src="/static/linkurious/src/captors/sigma.captors.mouse.js"></script>
<script src="/static/linkurious/src/captors/sigma.captors.touch.js"></script>
<script src="/static/linkurious/src/renderers/canvas/sigma.canvas.labels.def.js"></script>
<script src="/static/linkurious/src/renderers/canvas/sigma.canvas.hovers.def.js"></script>
<script src="/static/linkurious/src/renderers/canvas/sigma.canvas.nodes.def.js"></script>
<script src="/static/linkurious/src/renderers/canvas/sigma.canvas.edges.def.js"></script>
<script src="/static/linkurious/src/renderers/canvas/sigma.canvas.edgehovers.def.js"></script>
<script src="/static/linkurious/src/renderers/canvas/sigma.canvas.extremities.def.js"></script>
<script src="/static/linkurious/src/renderers/sigma.renderers.canvas.js"></script>
<script src="/static/linkurious/src/renderers/sigma.renderers.webgl.js"></script>
<script src="/static/linkurious/src/renderers/sigma.renderers.svg.js"></script>
<script src="/static/linkurious/src/renderers/sigma.renderers.def.js"></script>
<script src="/static/linkurious/src/middlewares/sigma.middlewares.rescale.js"></script>
<script src="/static/linkurious/src/middlewares/sigma.middlewares.copy.js"></script>
<script src="/static/linkurious/src/misc/sigma.misc.animation.js"></script>
<script src="/static/linkurious/src/misc/sigma.misc.drawHovers.js"></script>
<script src="/static/linkurious/src/misc/sigma.misc.bindEvents.js"></script>
<script src="/static/linkurious/src/misc/sigma.misc.bindDOMEvents.js"></script>
<script src="/static/linkurious/plugins/sigma.plugins.activeState/sigma.plugins.activeState.js"></script>
<script src="/static/linkurious/plugins/sigma.plugins.tooltips/sigma.plugins.tooltips.js"></script>
<script src="/static/linkurious/plugins/sigma.plugins.dragNodes/sigma.plugins.dragNodes.js"></script>
<script src="/static/linkurious/plugins/sigma.plugins.dragNodes/settings.js"></script>
<script src="/static/linkurious/plugins/sigma.parsers.json/sigma.parsers.json.js"></script>
<script src="/static/linkurious/plugins/sigma.layouts.forceAtlas2/worker.js"></script>
<script src="/static/linkurious/plugins/sigma.layouts.forceAtlas2/supervisor.js"></script>

<script src="/static/assets/js/jquery-url.min.js"></script>


{% extends "index.html" %}
{% block content %}



 <!-- Personnal import -->
<link href="/static/assets/css/ajaxload.css" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="/static/assets/css/graph.css" media="screen" />
<script src="/static/assets/js/generic_js.js"></script>






<!-- #################################################################### -->
<!--  Global variables  -->
<!-- #################################################################### -->
<script>
var all_types;
var all_digos;
var all_nodes;
var ajax_return;
var node_selected = {};

</script>



<!-- #################################################################### -->
<!--  HTML
<! #################################################################### -->

<!-- Graph container -->
<div id="graph-container"></div>

<!--  Zoom -->
<div class="btn-group" id="zoomController" role="group" aria-label="zoomController" style="margin-bottom: 20px;">
    <button type="button" class="btn btn-default" id="zoomIn" title="Zoom In"><i class="fa fa-search-minus"></i></button>
    <button type="button" class="btn btn-default" id="zoomReset" title="Zoom Reset"><i class="fa fa-compass"></i></button>
    <button type="button" class="btn btn-default" id="zoomOut" title="Zoom Out"><i class="fa fa-search-plus"></i></button>
</div>

<!--  Ajax - loading gif page  -->
<div class="ajaxload"></div>




<!-- #################################################################### -->
<!--  Graph configuration  -->
<!-- #################################################################### -->
<script>
var i,
    s,
    N = 100,
    E = 500,
    g = {
      nodes: [],
      edges: []
    };


    s = new sigma({
      graph: g,
      renderer: {
        container: document.getElementById('graph-container'),
        type: 'canvas'
      },
      settings: {

        // Labels:
        font: 'robotoregular',
        defaultLabelColor: '#2e2c2d',
        defaultLabelSize: 8,
        labelThreshold: 5,
        defaultEdgeLabelSize: 12,
        edgeLabelThreshold: 7,
        labelHoverShadow: '',

        // Edges:
        edgeColor: 'default',
        defaultEdgeColor: '#a9a9a9',

        // Nodes:
        defaultNodeColor: '#333333',

        // Hovered nodes:
        hoverFontStyle: 'bold',
        borderSize: 2,
        outerBorderSize: 2,
        nodeBorderColor: 'default',
        defaultNodeBorderColor: '#ffffff',
        defaultNodeOuterBorderColor: '#f65565',
        edgeHoverSizeRatio:3,
        enableEdgeHovering: true,
        edgeHoverHighlightNodes: 'circle',

        // Actve nodes and edges:
        activeFontStyle: 'bold',
        nodeActiveColor: 'node',
        defaultNodeActiveColor: '#333333',
        edgeActiveColor: 'default',
        defaultEdgeActiveColor: '#f65565',
        edgeHoverExtremities: true,

        /**
        * RESCALE SETTINGS:
        * *****************
        */
        minNodeSize: 20,
        maxNodeSize: 20,
        minEdgeSize: 0.5,
        maxEdgeSize: 0.5,

        /**
        * CAPTORS SETTINGS:
        * *****************
        */
        zoomingRatio: 1.1,
        doubleClickZoomingRatio: 1,
        zoomMin: 0.05,
        zoomMax: 5,
        doubleClickZoomDuration: 0,
        mouseWheelEnabled: false,

        /**
        * GLOBAL SETTINGS:
        * ****************
        */
        doubleClickEnabled: false,
        enableEdgeHovering: true,
        edgeHoverPrecision: 10,


        dragNodeStickiness: 0.01,

      }
    });



// #################################################################### -->
//  Action when clicking on nodes - edges  -->
// #################################################################### -->

var config = {
  node: [{

    //  Right click - Show details of nodes + edit node + delete node + add property + add relationship ... -->
    show: 'rightClickNode',
    cssClass: 'sigma-tooltip',
    autoadjust: true,
    renderer: function(node) {
      node_selected = node
      node.degree = this.degree(node.id);

      digos = "";
      type = node['properties']['type'].toLowerCase();
      var digos = "";
      for (var row in all_digos[type]) {
        digos += '<li id="link-actions"><a href="#">'+all_digos[type][row]+'</a></li>'
      }

      if (digos == ""){
        digos = '<li><a href="#">No digo available</a></li>'
      }

      output = `
      <div class="arrow" id="modal_rightClickNode" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"></div>
        <div class="modal-dialog" id="modal_dialog_rightClickNode">
          <div class="modal-content">
            <div class="modal-header" id="modal_header_rightClickNode">
              <div class="col-md-6">
                <h4 class="modal-title" id="modal_rightClickNode_label">Type: `+node.properties['type']+`</h4>
              </div>
              <div class="col-md-3">
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-mint btn-active-purple dropdown-toggle" data-toggle="dropdown" type="button">
                        Actions <i class="dropdown-caret"></i>
                    </button>
                    <ul class="dropdown-menu">
                        <li id="edit_node" value="`+node.id+`"><a href="#">Edit Node</a></li>
                        <li id="delete_node" value="`+node.id+`"><a href="#">Delete Node</a></li>
                        <li id="add_relationship" value="`+node.id+`"><a href="#">Add Relationship</a></li>
                        <li id="add_property" value="`+node.id+`"><a href="#">Add Property</a></li>
                    </ul>
                </div>
              </div>
              <div class="col-md-3">
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-mint btn-active-purple dropdown-toggle" data-toggle="dropdown" type="button">
                        Digos <i class="dropdown-caret"></i>
                    </button>
                    <ul class="dropdown-menu">
                        `+digos+`
                    </ul>
                </div>
              </div>
            </div>
            <div class="modal-body" id="modal_body_rightClickNode">
              <form id="rightClickNode_form">
                <div class="form-group">
                  <div class="col-md-4">
                    <label class="modal-form-label">id</label>
                  </div>
                  <div class="col-md-8">
                    <label class="modal-form-label">`+node.id+`</label>
                  </div>
                </div>
                <div class="form-group">
                  <div class="col-md-4">
                    <label class="modal-form-label">value</label>
                  </div>
                  <div class="col-md-8">
                    <label class="modal-form-label">`+node.label+`</label>
                  </div>
                </div>`;
      for (var row in node.properties){
        if (row != 'type'){
          output += `
          <div class="form-group">
            <div class="col-md-4">
              <label class="modal-form-label">`+row+`</label>
            </div>
            <div class="col-md-8">
              <label class="modal-form-label">`+node.properties[row]+`</label>
            </div>
          </div>`;
        }
      }
      output +=`
              </form>
            </div>
          </div>
        </div>
      `;
      return output
    }
  }],
  stage: [{

    autoadjust: true,
    //  Right click on background - Add node  -->
    renderer: function() {
      output = '<div class="arrow"></div>' +
      ' <div class="sigma-tooltip-header">Menu</div>' +
      '  <div class="sigma-tooltip-body">' +
      '    <table>' +
      '      <tr><th id="add_node"><a href="#">Add a node</a></th><td></td></tr>' +
      '    </table>' +
      '  </div>' +
      '  <div class="sigma-tooltip-footer"></div>'
      return output
    }
  }]
};


parameters_for_results = "";
parameters = url('?');
for (parameter_key in parameters){
  if (parameter_key == "campaign"){
    campaign = parameters[parameter_key];
    parameters_for_results = 'campaign='+campaign;
  }
}


//-- #################################################################### -->
//--  Sigma JSON Parser  -->
//-- #################################################################### -->

function sigma_json_parser(refresh){


  var count = {}

  sigma.parsers.json(
     '/get_neo4j_json_for_graph?'+parameters_for_results,
     s,
     function() {
         var i,
         nodes = s.graph.nodes();
         all_nodes = nodes
         edges = s.graph.edges();
         len_nodes = nodes.length;
         len_edges = edges.length;

         count['nodes'] = 0;
         count['relation'] = 0;
         for (i = 0; i < len_nodes; i++) {
           if(count[nodes[i].properties['type']]){
             count[nodes[i].properties['type']] += 1;
           }
           else {
              count[nodes[i].properties['type']] = 1;
           }
           count['nodes'] += 1;

           for (var key in colors_nodes){
             if(nodes[i].properties['type'] == key){
                nodes[i].color = colors_nodes[key]
             }
           }
           nodes[i].size = s.graph.degree(nodes[i].id);
         }

         for (i = 0; i < len_edges; i++) {
             edges[i].label = edges[i].type
             edges[i].size = 0.2
             edges[i].color = colors_edges
             count['relation'] += 1;
         }

         // Refresh the display:
         s.refresh();

         // ForceAtlas Layout
         if(refresh == false){
           s.startForceAtlas2({gravity:150,scalingRatio:70,slowDown:1000000});
           setTimeout(function(){s.stopForceAtlas2();},1000);
         }

         cornerbottomright = ""
         for (var key in count){
           cornerbottomright += key+'('+count[key]+')&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
         }
         $("#cornerbottomright").html(cornerbottomright);
       }
  );

  // Instanciate the ActiveState plugin:
  var activeState = sigma.plugins.activeState(s);
  // Initialize the dragNodes plugin:
  var dragListener = sigma.plugins.dragNodes(s, s.renderers[0], activeState);
  // Instanciate the tooltips plugin with a Mustache renderer for node tooltips:
  var tooltips = sigma.plugins.tooltips(s, s.renderers[0], config);

}






//-- #################################################################### -->
//--  Used for showing the loading gif  -->
//-- #################################################################### -->
$body = $("body");
$(document).on({
    ajaxStart: function() { $body.addClass("loading");    },
    ajaxStop: function() { $body.removeClass("loading"); }
});





//-- #################################################################### -->
//--  Get the whole list of actions available  -->
//-- #################################################################### -->
function write_all_digos_in_aside(){
  all_digos = get_all_digos()
  var actions = "";
  var count = 0;
  for (var row in all_digos) {
   count += 1;
  }
  actions += '<p class="pad-hor mar-top text-semibold text-main"><span class="pull-right badge badge-warning">'+count+'</span> List of Actions</p>';
  for (var row in all_digos) {
   actions += '<div id="aside-content_tab2" class="list-group bg-trans"><a href="#" class="list-group-item"><span class="badge badge-info badge-icon badge-fw pull-left"></span>'+all_digos[row]+'</a>';
  }
  actions += '</div>'
  $("#aside-content_tab2").html(actions);
}





//-- #################################################################### -->
//--  Beginning of the graph page  -->
//-- #################################################################### -->
function beginning_graph_page(){
  sigma_json_parser(false);
  all_types = get_all_nodes_types(false);
  setTimeout( function timer(){
    write_all_digos_in_aside();
  }, 500);
}

beginning_graph_page()



//-- #################################################################### -->
//--  Refresh function  -->
//-- #################################################################### -->
function refresh_graph(time){
  write_all_digos_in_aside(false);
  all_types = get_all_nodes_types(false);
  loading_gif(time);
  sigma_json_parser(false);
}




//-- #################################################################### -->
//--  Delete node -->
//-- #################################################################### -->
$(document).on('click', '#delete_node', function() {
  BootstrapDialog.confirm({
    title: 'WARNING',
    message: 'Are you sure you want to delete the node ?',
    type: BootstrapDialog.TYPE_DANGER,
    closable: true,
    draggable: true,
    btnCancelLabel: 'Cancel!',
    btnOKLabel: 'Delete!',
    btnOKClass: 'btn-warning',
    callback: function(result) {
        if(result) {
          id = $("#delete_node").val();
          delete_node(id);
          refresh_graph(500);
        }
    }
  });
});



//-- #################################################################### -->
//--  Action - Add a node -->
//-- #################################################################### -->
$(document).on('click', '#add_node', function() {
  var output = "";
  for (var row in all_types) {
      output += '<option data-value="'+row+'" value="'+row+'"  />';
  }
  $('#types').html(output)

  $('#modal_add_new_node').modal()
  $('#modal_add_new_node').on('show.bs.modal', function() {
    $('#add_node_form').bootstrapValidator('resetForm', true);
  });

  $(document).ready(function() {
    $('#add_node_form').bootstrapValidator({
        message: 'This value is not valid',
        feedbackIcons: {
          valid: 'glyphicon glyphicon-ok',
          invalid: 'glyphicon glyphicon-remove',
          validating: 'glyphicon glyphicon-refresh'
        },
        excluded: [':disabled'],
        fields: {
          type: {
            validators: {
              notEmpty: {
                message: 'The type is required'
              }
            }
          },
          value: {
            validators: {
              notEmpty: {
                message: 'The value is required'
              }
            }
          }
        }
      })
      .on('success.form.bv', function(e) {
          e.preventDefault();
          e.stopImmediatePropagation();
          var valuesToSubmit = $(this).serialize();
          add_node(valuesToSubmit);
          $('#modal_add_new_node').modal('hide')
          refresh_graph(500);
      });
  });
});



//-- #################################################################### -->
//--  Action - Add a relationship -->
//-- #################################################################### -->
$(document).on('click', '#add_relationship', function() {
  var output = "";
  for (var row in all_nodes) {
      output += '<option value="'+all_nodes[row]['id']+' - '+all_nodes[row]['label']+'"  />';
  }
  $('#relations').html(output)

  $('#modal_add_new_relationship').modal()
  $('#modal_add_new_relationship').on('show.bs.modal', function() {
    $('#add_relationship_form').bootstrapValidator('resetForm', true);
  });

  $(document).ready(function() {
    $('#add_relationship_form').bootstrapValidator({
        message: 'This value is not valid',
        feedbackIcons: {
          valid: 'glyphicon glyphicon-ok',
          invalid: 'glyphicon glyphicon-remove',
          validating: 'glyphicon glyphicon-refresh'
        },
        excluded: [':disabled'],
        fields: {
          id1: {
            validators: {
              notEmpty: {
                message: 'The relationship is required'
              },
              callback: {
                message: 'Choose another relationship!',
                callback: function (value, validator, $field) {
                  var id2 = $('#add_relationship').val();
                  return value.split(' - ',1)[0] != id2;
                }
              }
            },
          },
        }
      })
      .on('success.form.bv', function(e) {
          e.preventDefault();
          e.stopImmediatePropagation();
          var valuesToSubmit = $(this).serialize();
          id1 = valuesToSubmit.split('+-+')[0].split('=')[1];
          id2 = $('#add_relationship').val();
          add_relationship(id1, id2);
          $('#modal_add_new_relationship').modal('hide')
          refresh_graph(500);
      });
  });
});




//-- #################################################################### -->
//--  Action - Add a property -->
//-- #################################################################### -->

$(document).on('click', '#add_property', function() {

  $('#modal_add_new_property').modal()
  $('#modal_add_new_property').on('show.bs.modal', function() {
    $('#add_property_form').bootstrapValidator('resetForm', true);
  });

  $(document).ready(function() {
    $('#add_property_form').bootstrapValidator({
        message: 'This value is not valid',
        feedbackIcons: {
          valid: 'glyphicon glyphicon-ok',
          invalid: 'glyphicon glyphicon-remove',
          validating: 'glyphicon glyphicon-refresh'
        },
        excluded: [':disabled'],
        fields: {
          propertykey: {
            validators: {
              notEmpty: {
                message: 'The key is required'
              },
            },
          },
          propertyvalue: {
            validators: {
              notEmpty: {
                message: 'The value is required'
              },
            },
          },
        }
      })
      .on('success.form.bv', function(e) {
          e.preventDefault();
          e.stopImmediatePropagation();
          var valuesToSubmit = $(this).serialize();
          id = $("#add_property").val();
          propertykey = valuesToSubmit.split('propertykey=')[1].split('&propertyvalue')[0]
          propertyvalue = valuesToSubmit.split('propertyvalue=')[1]
          add_property(id, propertykey, propertyvalue)
          $('#modal_add_new_property').modal('hide')
          refresh_graph(500);
      });
  });
});







//-- #################################################################### -->
//--  Action - Edit a node -->
//-- #################################################################### -->

$(document).on('click', '#edit_node', function() {

  $("#edit_node_form").bootstrapValidator("destroy");

  var count_result_edit = 0;

  output = `
    <div class="form-group">
      <div class="col-md-6">
        <label class="modal-form-label">Key</label>
      </div>
      <div class="col-md-6">
        <label class="modal-form-label">Value</label>
      </div>
    </div>
    <div class="form-group">
      <div class="col-md-6">
        <input type=text class="form-control modal-form-input" name="key_`+count_result_edit+`" value="id" readonly></input>
      </div>
      <div class="col-md-6">
        <input type=text class="form-control modal-form-input" name="value_`+count_result_edit+`" value=`+node_selected.id+` readonly></input>
      </div>
    </div>`;
  count_result_edit += 1;

  output += `
    <div class="form-group">
      <div class="col-md-6">
        <input type=text class="form-control modal-form-input" name="key_`+count_result_edit+`" value="value" readonly></input>
      </div>
      <div class="col-md-6">
        <input type=text class="form-control modal-form-input" name="value_`+count_result_edit+`" value=`+node_selected.label+` pattern="^[a-zA-Z0-9_.-\s]*$" data-bv-regexp-message="The value cannot contain special character"></input>
      </div>
    </div>`;
  count_result_edit += 1;

  for (var row in node_selected.properties){
    if (row == "type"){
      output += `
        <div class="form-group">
          <div class="col-md-6">
            <input type=text class="form-control modal-form-input" name="key_`+count_result_edit+`" value=`+row+` readonly></input>
          </div>
          <div class="col-md-6">
            <input type=text class="form-control modal-form-input" name="value_`+count_result_edit+`" value=`+node_selected.properties[row]+` pattern="^[a-zA-Z0-9_.-\s]*$" data-bv-regexp-message="The value cannot contain special character"></input>
          </div>
        </div>`;
    } else {
      output += `
        <div class="form-group">
          <div class="col-md-6">
            <input type=text class="form-control modal-form-input" name="key_`+count_result_edit+`" value=`+row+` pattern="^[a-zA-Z][a-zA-Z0-9_-]*$" data-bv-regexp-message="The key cannot start with a number of special character"></input>
          </div>
          <div class="col-md-6">
            <input type=text class="form-control modal-form-input" name="value_`+count_result_edit+`" value=`+node_selected.properties[row]+` pattern="^[a-zA-Z0-9_.-\s]*$" data-bv-regexp-message="The key cannot start with a number of special character"></input>
          </div>
        </div>`;
    }
    count_result_edit += 1;
  }

  output+= `
    <div class="form-group">
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Edit node</button>
      </div>
    </div>`;

  // pattern="^[a-zA-Z][a-zA-Z0-9_-]*$" data-bv-regexp-message="The key cannot start with a number of special character"
  $('#edit_node_form').html(output);
  $('#modal_edit_node').modal();


  $(document).ready(function() {
    $('#edit_node_form').bootstrapValidator({
      message: 'This value is not valid',
      feedbackIcons: {
        valid: 'glyphicon glyphicon-ok',
        invalid: 'glyphicon glyphicon-remove',
        validating: 'glyphicon glyphicon-refresh'
      },
      excluded: [':disabled']
    })
    .on('success.form.bv', function(e) {
        e.preventDefault();
        e.stopImmediatePropagation();
        var array = {}
        for(i=0; i<count_result_edit; i++){
          key = $('input[name="key_'+i+'"]').val();
          value = $('input[name="value_'+i+'"]').val();
          array[key] = value;
        }
        edit_node(array);
        $('#modal_edit_node').modal('hide')
        refresh_graph(500);
      });
  });
});



//-- #################################################################### -->
//--  Action - Results from actions -->
//-- #################################################################### -->

$(document).on('click', '#link-actions', function() {
  var count_result_action = 0;
  action = $("#link-actions").text();
  value = node_selected.label;
  var data = get_digo_result(action, value);
  output = `
    <div class="form-group">
      <div class="col-md-1">
        <label class="modal-form-label">Node</label>
      </div>
      <div class="col-md-1">
        <label class="modal-form-label">Property</label>
      </div>
      <div class="col-md-5">
        <label class="modal-form-label">Type</label>
      </div>
      <div class="col-md-5">
        <label class="modal-form-label">Details</label>
      </div>
    </div>`;
  json_result = data["json_result"];
  for (var key in json_result) {
    count_result_action += 1;
    output += `
      <div class="form-group">
        <div class="col-md-1">
          <input type="checkbox" class="form-control modal-form-input" name="node_check_`+count_result_action+`" value="`+key+`;`+json_result[key]+`" pattern="^[a-zA-Z][a-zA-Z0-9_-]*$" data-bv-regexp-message="The key cannot start with a number of special character">
        </div>
        <div class="col-md-1">
          <input type="checkbox" class="form-control modal-form-input" name="prop_check_`+count_result_action+`" value="`+key+`;`+json_result[key]+`" pattern="^[a-zA-Z0-9_.-\s]*$" data-bv-regexp-message="The value cannot contain special character">
        </div>
        <div class="col-md-5">
          <input type=text class="form-control modal-form-input" id="key-modal" name="node_key_`+count_result_action+`" value=`+key+` pattern="^[a-zA-Z][a-zA-Z0-9_-]*$" data-bv-regexp-message="The key cannot start with a number of special character"></input>
        </div>
        <div class="col-md-5">
          <input type=text class="form-control modal-form-input" id="value-modal" name="node_value_`+count_result_action+`" value=`+json_result[key]+` pattern="^[a-zA-Z0-9_.-\s]*$" data-bv-regexp-message="The value cannot contain special character"></input>
        </div>
      </div>`;
  }
  output += `
    <div class="form-group">
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Edit node</button>
      </div>
    </div>`;

  $('#receive_action_form').html(output);
  $('#modal_receive_action').modal();

  $(document).ready(function() {
    $('#receive_action_form').bootstrapValidator({
      message: 'This value is not valid',
      feedbackIcons: {
        valid: 'glyphicon glyphicon-ok',
        invalid: 'glyphicon glyphicon-remove',
        validating: 'glyphicon glyphicon-refresh'
      },
      excluded: [':disabled']
    })
    .on('success.form.bv', function(e) {
      e.preventDefault();
      e.stopImmediatePropagation();
      var count = 0;
      for(i=0; i<count_result_action; i++){
        count += 1;
        $('input[name="node_check_'+i+'"]:checked').each(function() {
          type = $('input[name="node_key_'+i+'"]').val();
          value = $('input[name="node_value_'+i+'"]').val();
          valuesToSubmit = ('type='+type+'&value='+value+'&confidence=&diamondmodel=&campaign=&firstseen=&lastseen=&tags=&comments=');
          id1 = node_selected.id;
          tmp = add_node(valuesToSubmit);
          id2 = tmp.responseText
          add_relationship(id1, id2);
        });
        $('input[name="prop_check_'+i+'"]:checked').each(function() {
          type = $('input[name="node_key_'+i+'"]').val();
          value = $('input[name="node_value_'+i+'"]').val();
          id = node_selected.id;
          add_property(id, type, value);
        });
      }
    });
  });
});








//-- #################################################################### -->
//--  Zoom -->
//-- #################################################################### -->
var zoomOut = function() {
  sigma.utils.zoomTo(
      s.camera,
      0,
      0,
      1 / s.settings('zoomingRatio'),
      { duration: 300 }
    );
};
var zoomIn = function() {
  sigma.utils.zoomTo(
      s.camera,
      0,
      0,
      s.settings('zoomingRatio'),
      { duration: 300 }
    );
};
var zoomCenter = function() {
  var loc = sigma.plugins.locate(s);
  loc.center(1);
};

$(document).ready(function() {
  $('#zoomIn').on('click',function(e) {
    e.preventDefault();
    zoomIn();
  });
  $('#zoomOut').on('click',function(e) {
    e.preventDefault();
    zoomOut();
  });
  $('#zoomReset').on('click',function(e) {
    e.preventDefault();
    zoomCenter();
  });
});



</script>


<!-- #################################################################### -->
<!--  Modal used for adding a node -->
<!-- #################################################################### -->
<div class="modal fade" id="modal_add_new_node" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">
          <span aria-hidden="true">&times;</span>
          <span class="sr-only">Close</span>
        </button>
        <h4 class="modal-title" id="myModalLabel">New node</h4>
      </div>
      <div class="modal-body">
        <form id="add_node_form">
          <div class="form-group">
            <div class="col-md-12">
              <label class="modal-form-label">Type (required)</label></br>
              <div class="dropdown">
                <input class="form-control modal-form-input" name="type" type="search" id="inputtype" list="types" placeholder="Pick a type ..." >
                <datalist id="types"></datalist>
              </div>
            </div>
          </div>
          <div class="form-group">
            <div class="col-md-12">
              <label class="modal-form-label">Value (required)</label>
              <input class="form-control modal-form-input" name="value" type=text  id="inputvalue" placeholder="8.8.8.8, or toto.com ..." />
            </div>
          </div>
          <div class="form-group">
            <div class="col-md-12">
              <label class="modal-form-label">Confidence (optional)</label>
              <select class="form-control modal-form-input" name="confidence" id="inputconfidence">
                <option value="" selected="true"></option>
                <option value="Low">Low</option>
                <option value="Medium">Medium</option>
                <option value="High">High</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <div class="col-md-12">
              <label class="modal-form-label">Diamond Model (optional)</label>
              <select class="form-control modal-form-input" name="diamondmodel" id="inputdiamondmodel">
                <option value="" selected="true"></option>
                <option value="Adversary">Adversary</option>
                <option value="Infrastructure">Infrastructure</option>
                <option value="Victim">Victim</option>
                <option value="Capability">Capability</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <div class="col-md-12">
              <label class="modal-form-label">Campaign/Investigation (optional) </label></br>
              <div class="dropdown">
                <input class="form-control modal-form-input" name="campaign" list="types" type="search" placeholder="Pick a campaign ..." id="inputcampaign">
                <datalist id="typdes">plop</datalist>
              </div>
            </div>
          </div>
          <div class="form-group">
            <div class="col-md-12">
              <label class="modal-form-label">First Seen (optional)</label>
              <input type=text class="form-control modal-form-input" name="firstseen" id="inputfirstseen" placeholder="15/10/2016"></input>
            </div>
          </div>
          <div class="form-group">
            <div class="col-md-12">
              <label class="modal-form-label">Last Seen (optional)</label>
              <input type=text class="form-control modal-form-input" name="lastseen" id="inputlastseen" placeholder="15/10/2016"></input>
            </div>
          </div>
          <div class="form-group">
            <div class="col-md-12">
              <label class="modal-form-label">Tags (optional)</label>
              <input type=text class="form-control modal-form-input" name="tags" id="inputtags" placeholder="ransomware, phishing, etc."></input>
            </div>
          </div>
          <div class="form-group">
            <div class="col-md-12">
              <label class="modal-form-label">Comments (optional)</label>
              <textarea class="form-control modal-form-input" name="comments" id="inputcomments" row="4" placeholder="Up to you :P"></textarea>
            </div>
          </div>
          <div class="form-group">
            <div class="modal-footer">
              <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary">Add new node</button>
            </div>
          </div>
        </form>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->



<!-- #################################################################### -->
<!--  Modal used for adding a relationship -->
<!-- #################################################################### -->
<div class="modal fade" id="modal_add_new_relationship" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">
          <span aria-hidden="true">&times;</span>
          <span class="sr-only">Close</span>
        </button>
        <h4 class="modal-title" id="myModalLabel">New relationship</h4>
      </div>
      <div class="modal-body">
        <form id="add_relationship_form">
          <div class="form-group">
            <div class="col-md-12">
              <label class="modal-form-label">Relationship</label></br>
              <div class="dropdown">
                <input class="form-control modal-form-input" name="id1" type="search" id="inputid" list="relations" placeholder="Pick a type ..." >
                <datalist id="relations"></datalist>
              </div>
            </div>
          </div>
          <div class="form-group">
            <div class="modal-footer">
              <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary">Add new relationship</button>
            </div>
          </div>
        </form>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->


<!-- #################################################################### -->
<!--  Modal used for adding a property -->
<!-- #################################################################### -->
<div class="modal fade" id="modal_add_new_property" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">
          <span aria-hidden="true">&times;</span>
          <span class="sr-only">Close</span>
        </button>
        <h4 class="modal-title" id="myModalLabel">New property</h4>
      </div>
      <div class="modal-body">
        <form id="add_property_form">
          <div class="form-group">
            <div class="col-md-12">
              <label class="modal-form-label">Key</label>
              <input type=text class="form-control modal-form-input" name="propertykey" id="inputpropertykey" placeholder="address, etc."></input>
            </div>
          </div>
          <div class="form-group">
            <div class="col-md-12">
              <label class="modal-form-label">Value</label>
              <input type=text class="form-control modal-form-input" name="propertyvalue" id="inputpropertyvalue" placeholder="5 collins street ..."></input>
            </div>
          </div>
          <div class="form-group">
            <div class="modal-footer">
              <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary">Add new property</button>
            </div>
          </div>
        </form>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->



<!-- #################################################################### -->
<!--  Modal used for editting a node -->
<!-- #################################################################### -->
<div class="modal fade" id="modal_edit_node" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">
          <span aria-hidden="true">&times;</span>
          <span class="sr-only">Close</span>
        </button>
        <h4 class="modal-title" id="myModalLabel">Edit node</h4>
      </div>
      <div class="modal-body">
        <form id="edit_node_form">
        </form>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->





<!-- #################################################################### -->
<!--  Modal used when receiving result from an action -->
<!-- #################################################################### -->
<div class="modal fade" id="modal_receive_action" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">
          <span aria-hidden="true">&times;</span>
          <span class="sr-only">Close</span>
        </button>
        <h4 class="modal-title" id="myModalLabel">Edit node</h4>
      </div>
      <div class="modal-body">
        <form id="receive_action_form">
        </form>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->



{% endblock content %}
